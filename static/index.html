<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ScriptTranslit - Select & Transliterate</title>
<style>
body, html { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:system-ui, sans-serif;}
#app { position:relative; height:100vh; width:100vw; overflow:hidden; }
video#cam { width:100%; height:100%; object-fit:cover; }
canvas#overlay { position:absolute; left:0; top:0; pointer-events:auto; }
#controls { position:absolute; bottom:12px; left:12px; display:flex; gap:8px; z-index:50; }
button, select { padding:8px 12px; border-radius:8px; border:none; background:rgba(255,255,255,0.12); color:white; }
#info { position:absolute; top:8px; left:8px; z-index:60; background:rgba(0,0,0,0.4); padding:6px 8px; border-radius:6px;}
#gallery { position:absolute; bottom:80px; left:12px; right:12px; z-index:40; background:rgba(0,0,0,0.7); border-radius:8px; padding:8px; max-height:40vh; overflow-y:auto; }
#loader { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:1.2em; display:none; background:rgba(0,0,0,0.6); padding:12px 16px; border-radius:8px; z-index:100; }
</style>
</head>
<body>
<div id="app">
  <div id="info">Capture an image, then drag to select area for transliteration</div>
  <div id="loader">Transliterating...</div>
  <video id="cam" autoplay playsinline></video>
  <canvas id="overlay"></canvas>

  <div id="controls">
    <select id="toScript">
      <option value="iast">Latin (IAST)</option>
      <option value="devanagari">Devanagari</option>
      <option value="gurmukhi">Gurmukhi</option>
      <option value="tamil">Tamil</option>
      <option value="telugu">Telugu</option>
      <option value="kannada">Kannada</option>
      <option value="malayalam">Malayalam</option>
    </select>
    <button id="capture">Capture</button>
    <button id="ocrRegion">Transliterate Selection</button>
  </div>

  <div id="gallery">
    <h3 style="margin:0 0 8px 0; font-size:1.1em;">Captured Images & Transliteration</h3>
    <div id="captures"></div>
  </div>
</div>

<script src="https://unpkg.com/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@indic-transliteration/sanscript@1.2.8/sanscript.min.js"></script>
<script>
const video = document.getElementById('cam');
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
const captureBtn = document.getElementById('capture');
const ocrBtn = document.getElementById('ocrRegion');
const toSelect = document.getElementById('toScript');
const loader = document.getElementById('loader');

let worker=null, workerReady=false, capturedImage=null;
let selecting=false, selStart={}, selEnd={}, selectionRect=null;
let captures=[];

// Script detection for Indian scripts
function detectScript(text){
  if (/[\u0900-\u097F]/.test(text)) return 'devanagari';
  if (/[\u0A00-\u0A7F]/.test(text)) return 'gurmukhi';
  if (/[\u0B80-\u0BFF]/.test(text)) return 'tamil';
  if (/[\u0C00-\u0C7F]/.test(text)) return 'telugu';
  if (/[\u0C80-\u0CFF]/.test(text)) return 'kannada';
  if (/[\u0D00-\u0D7F]/.test(text)) return 'malayalam';
  if (/[\u0041-\u007A]/.test(text)) return 'latin';
  return 'devanagari';
}

// Init camera
async function initCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment', width:{ideal:1280}, height:{ideal:720}}});
    video.srcObject=stream;
    await new Promise(r=>video.onloadedmetadata=r);
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    startWorker();
  }catch(e){alert("Camera failed: "+e);}
}

// Start Tesseract worker
async function startWorker(){
  worker = Tesseract.createWorker({ logger: m=>console.log(m) });
  await worker.load();
  await worker.loadLanguage('hin+tam+pan+mal+tel+kan+eng');
  await worker.initialize('hin+tam+pan+mal+tel+kan+eng');
  workerReady=true;
}

// Capture frame
captureBtn.addEventListener('click', ()=>{
  const tmp=document.createElement('canvas');
  tmp.width=canvas.width; tmp.height=canvas.height;
  tmp.getContext('2d').drawImage(video,0,0,tmp.width,tmp.height);
  capturedImage=tmp;
  drawCaptured();
});

// Draw captured image + selection
function drawCaptured(){
  if(!capturedImage) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(capturedImage,0,0);
  if(selectionRect){
    ctx.strokeStyle='lime'; ctx.lineWidth=2;
    ctx.strokeRect(selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
  }
}

// Mouse selection
canvas.addEventListener('mousedown', e=>{
  if(!capturedImage) return;
  selecting=true;
  selStart={x:e.offsetX,y:e.offsetY};
});
canvas.addEventListener('mousemove', e=>{
  if(selecting){
    selEnd={x:e.offsetX,y:e.offsetY};
    updateSelectionRect();
    drawCaptured();
  }
});
canvas.addEventListener('mouseup', e=>{
  selecting=false;
  selEnd={x:e.offsetX,y:e.offsetY};
  updateSelectionRect();
  drawCaptured();
});

// Touch selection
canvas.addEventListener('touchstart', e=>{
  if(!capturedImage) return;
  selecting=true;
  const t=e.touches[0];
  selStart={x:t.clientX*canvas.width/window.innerWidth, y:t.clientY*canvas.height/window.innerHeight};
});
canvas.addEventListener('touchmove', e=>{
  if(selecting){
    const t=e.touches[0];
    selEnd={x:t.clientX*canvas.width/window.innerWidth, y:t.clientY*canvas.height/window.innerHeight};
    updateSelectionRect(); drawCaptured();
  }
});
canvas.addEventListener('touchend', e=>{ selecting=false; drawCaptured(); });

// Update selection rectangle
function updateSelectionRect(){
  if(!selStart || !selEnd) return;
  const x=Math.min(selStart.x, selEnd.x);
  const y=Math.min(selStart.y, selEnd.y);
  const w=Math.abs(selStart.x-selEnd.x);
  const h=Math.abs(selStart.y-selEnd.y);
  selectionRect={x,y,w,h};
}

// OCR + Transliterate selection
ocrBtn.addEventListener('click', async ()=>{
  if(!capturedImage || !selectionRect || !workerReady) return;
  loader.style.display='block';

  const tmp=document.createElement('canvas');
  tmp.width=selectionRect.w; tmp.height=selectionRect.h;
  const tctx = tmp.getContext('2d');
  tctx.drawImage(capturedImage, selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h, 0,0,selectionRect.w,selectionRect.h);

  const { data:{ words } } = await worker.recognize(tmp);
  const to = toSelect.value;

  const transliteratedWords = words.filter(w=>w.text && w.confidence>=20).map(w=>{
    const from = detectScript(w.text);
    try{
      return Sanscript.t(w.text, from, to);
    }catch(e){
      console.warn(`Transliteration failed for word: "${w.text}" from ${from} to ${to}`, e);
      return w.text;
    }
  });

  console.log("Transliterated output:", transliteratedWords.join(" "));

  // Draw overlay
  ctx.clearRect(selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
  ctx.drawImage(capturedImage, selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
  ctx.save(); ctx.fillStyle='#ffff88'; ctx.font='20px sans-serif';
  for(const w of words){
    if(!w.text || w.confidence<20) continue;
    const from = detectScript(w.text);
    let ttext = w.text;
    try{ ttext = Sanscript.t(w.text, from, to); }catch(e){ console.warn(`Overlay transliteration failed for "${w.text}"`); }
    const x = selectionRect.x + w.bbox.x0;
    const y = selectionRect.y + w.bbox.y0;
    ctx.fillText(ttext, x, y);
  }
  ctx.restore();

  const resultText = transliteratedWords.join(' ');
  captures.unshift({ img: tmp.toDataURL(), text: resultText });
  updateGallery();
  loader.style.display='none';
});

function updateGallery(){
  const container = document.getElementById('captures');
  container.innerHTML='';
  for(const cap of captures){
    const div=document.createElement('div');
    div.style.display='flex'; div.style.alignItems='center';
    div.style.marginBottom='8px';
    div.innerHTML=`<img src="${cap.img}" style="width:80px;height:60px;object-fit:cover;border-radius:4px;margin-right:8px;border:1px solid #444;" /><span style="color:#ffff88;">${cap.text}</span>`;
    container.appendChild(div);
  }
}

window.addEventListener('resize',()=>{canvas.width=video.videoWidth; canvas.height=video.videoHeight; drawCaptured();});
initCamera();
</script>
</body>
</html>
